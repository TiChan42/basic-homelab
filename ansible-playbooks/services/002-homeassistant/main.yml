---
# ==============================================================================
# Playbook: Services - Home Assistant OS (VM)
# Description: Provisions a Proxmox KVM virtual machine running Home Assistant
#              Operating System with USB passthrough, Zigbee2MQTT, Matter, and
#              automated NAS backup/restore.
#
# Process:
# 1. Proxmox VM Provisioning (localhost):
#    - Downloads the HAOS qcow2 image.
#    - Creates a UEFI-based KVM VM (q35 machine type).
#    - Imports the disk image and configures boot.
#    - Passes through USB devices (e.g. Sonoff Zigbee dongle).
#    - Starts VM and waits for HA API to become available.
#
# 2. Home Assistant Configuration (localhost → HA API):
#    - Completes onboarding (creates admin user).
#    - Configures static IP via Supervisor Network API.
#    - Installs Add-ons: Zigbee2MQTT, Matter Server, Samba Backup.
#    - Configures Zigbee2MQTT to use the external Mosquitto broker.
#    - Configures MQTT integration in HA.
#
# 3. Backup Concept (localhost cron → HA API → NAS):
#    - A cron job on the Proxmox host triggers HA backups via the API.
#    - The backup file is downloaded and stored on the NAS mount.
#    - On restore: backup is uploaded via HA API and restored.
#
# Architecture Note – USB Passthrough:
#   The Sonoff Zigbee USB dongle is passed through to the HA VM,
#   NOT to the MQTT broker container. The data flow is:
#     Zigbee Dongle (USB) → Zigbee2MQTT (HA Add-on) → Mosquitto (LXC)
#   Mosquitto only receives MQTT messages and does not need USB access.
#
# Inventory Requirements (in 'homeassistant' group):
#   - ha_vm_id                     (unique Proxmox VMID)
#   - ha_vm_name                   (Proxmox VM Name, matches inventory_hostname)
#   - ansible_host                 (static IP for HA)
# ==============================================================================

# ============================================================
# PLAY 1 – Provision the HAOS VM on the Proxmox host
# ============================================================
- name: Provision Home Assistant OS VM
  hosts: localhost
  become: yes
  gather_facts: yes
  tags: [provision]
  vars_files:
    - "../../inventory/group_vars/all.yml"

  tasks:
    # ------------------------------------------------------------------
    # Prerequisites
    # ------------------------------------------------------------------
    - name: Ensure required packages are installed
      apt:
        name:
          - python3-proxmoxer
          - python3-websocket
          - wget
          - xz-utils
          - jq
          - curl
        state: present
        update_cache: yes

    # ------------------------------------------------------------------
    # Download HAOS image
    # ------------------------------------------------------------------
    - name: Ensure download directory exists
      file:
        path: "{{ ha_image_download_dir }}"
        state: directory
        mode: '0755'

    - name: Check if HAOS image already exists
      stat:
        path: "{{ ha_image_download_dir }}/haos_ova-{{ ha_os_version }}.qcow2"
      register: haos_image

    - name: Download HAOS qcow2 image (compressed)
      get_url:
        url: "{{ ha_image_url }}"
        dest: "{{ ha_image_download_dir }}/haos_ova-{{ ha_os_version }}.qcow2.xz"
        mode: '0644'
      when: not haos_image.stat.exists

    - name: Decompress HAOS image
      command: "xz -d -k {{ ha_image_download_dir }}/haos_ova-{{ ha_os_version }}.qcow2.xz"
      args:
        creates: "{{ ha_image_download_dir }}/haos_ova-{{ ha_os_version }}.qcow2"
      when: not haos_image.stat.exists

    # ------------------------------------------------------------------
    # VM creation (loop over homeassistant group)
    # ------------------------------------------------------------------
    - name: Check if VM already exists
      command: "qm status {{ hostvars[item]['ha_vm_id'] }}"
      register: vm_exists
      failed_when: false
      changed_when: false
      loop: "{{ groups['homeassistant'] }}"

    - name: Create HAOS VM
      command: >
        qm create {{ hostvars[item.item]['ha_vm_id'] }}
        --name {{ hostvars[item.item]['ha_vm_name'] }}
        --memory {{ ha_vm_memory }}
        --cores {{ ha_vm_cores }}
        --cpu {{ ha_vm_cpu_type }}
        --bios ovmf
        --machine q35
        --ostype l26
        --agent 1
        --net0 virtio,bridge={{ ha_vm_bridge }}{{ ',macaddr=' + ha_vm_mac if ha_vm_mac | default('') | length > 0 else '' }}
        --scsihw virtio-scsi-pci
        --onboot 1
        --efidisk0 {{ default_storage }}:1
      loop: "{{ vm_exists.results }}"
      when: item.rc != 0
      loop_control:
        label: "{{ item.item }}"

    - name: Import HAOS disk image into VM
      command: "qm importdisk {{ hostvars[item.item]['ha_vm_id'] }} {{ ha_image_download_dir }}/haos_ova-{{ ha_os_version }}.qcow2 {{ default_storage }}"
      loop: "{{ vm_exists.results }}"
      when: item.rc != 0
      loop_control:
        label: "{{ item.item }}"

    - name: Attach imported disk as scsi0
      command: "qm set {{ hostvars[item.item]['ha_vm_id'] }} --scsi0 {{ default_storage }}:vm-{{ hostvars[item.item]['ha_vm_id'] }}-disk-1"
      loop: "{{ vm_exists.results }}"
      when: item.rc != 0
      loop_control:
        label: "{{ item.item }}"

    - name: Resize disk to desired size
      command: "qm resize {{ hostvars[item.item]['ha_vm_id'] }} scsi0 {{ ha_vm_disk_size }}"
      loop: "{{ vm_exists.results }}"
      when: item.rc != 0
      loop_control:
        label: "{{ item.item }}"

    - name: Set boot order to scsi0
      command: "qm set {{ hostvars[item.item]['ha_vm_id'] }} --boot order=scsi0"
      loop: "{{ vm_exists.results }}"
      when: item.rc != 0
      loop_control:
        label: "{{ item.item }}"

    # ------------------------------------------------------------------
    # USB passthrough – auto-detect Zigbee dongles
    # ------------------------------------------------------------------
    - name: Scan USB bus for connected devices
      command: lsusb
      register: lsusb_output
      changed_when: false

    - name: Auto-detect known Zigbee/USB dongles
      set_fact:
        ha_detected_usb_devices: >-
          {{ ha_known_zigbee_dongles
             | selectattr('vid_pid', 'in', lsusb_output.stdout)
             | map(attribute='vid_pid')
             | list }}

    - name: Show detected USB dongles
      debug:
        msg: |
          Detected {{ ha_detected_usb_devices | length }} known dongle(s): {{ ha_detected_usb_devices | join(', ') }}
          {% if ha_detected_usb_devices | length == 0 %}
          WARNING: No known Zigbee dongle found!
          Known IDs searched: {{ ha_known_zigbee_dongles | map(attribute='vid_pid') | join(', ') }}
          Connected USB: {{ lsusb_output.stdout_lines | join(', ') }}
          {% endif %}

    - name: Merge auto-detected with manually specified USB devices
      set_fact:
        ha_usb_final_devices: >-
          {{ (ha_detected_usb_devices + ha_usb_extra_devices) | unique | list }}

    - name: Configure USB device passthrough for detected dongles
      command: "qm set {{ hostvars[usb_passthrough_item.0]['ha_vm_id'] }} --usb{{ ansible_loop.index0 }} host={{ usb_passthrough_item.1 }},usb3=1"
      loop: "{{ groups['homeassistant'] | product(ha_usb_final_devices) | list }}"
      loop_control:
        loop_var: usb_passthrough_item
        label: "VM {{ hostvars[usb_passthrough_item.0]['ha_vm_id'] }} <- USB {{ usb_passthrough_item.1 }}"
        extended: true
      when: ha_usb_final_devices | length > 0

    - name: Warn if no USB devices found and none manually specified
      debug:
        msg: >
          WARNING: No USB devices passed through to HA VM!
          Plug in your Zigbee dongle and re-run, or add the device ID
          manually to 'ha_usb_extra_devices' in group_vars/all.yml.
          Find IDs with: lsusb
      when: ha_usb_final_devices | length == 0

    # ------------------------------------------------------------------
    # Start VM
    # ------------------------------------------------------------------
    - name: Start Home Assistant VM
      command: "qm start {{ hostvars[item]['ha_vm_id'] }}"
      register: vm_start
      failed_when:
        - vm_start.rc != 0
        - "'already running' not in vm_start.stderr"
      changed_when: vm_start.rc == 0
      loop: "{{ groups['homeassistant'] }}"

    # ------------------------------------------------------------------
    # Auto-detect VM IP via QEMU Guest Agent
    # ------------------------------------------------------------------
    - name: Wait for QEMU Guest Agent to become ready
      command: "qm guest cmd {{ hostvars[item]['ha_vm_id'] }} ping"
      register: agent_ping
      retries: 30
      delay: 10
      until: agent_ping.rc == 0
      changed_when: false
      loop: "{{ groups['homeassistant'] }}"

    - name: Detect VM IP address via QEMU Guest Agent
      shell: >-
        qm guest cmd {{ hostvars[item]['ha_vm_id'] }} network-get-interfaces
        | jq -r '[.[] | select(.name != "lo") | ."ip-addresses"[]?
        | select(."ip-address-type" == "ipv4")] | .[0]."ip-address"'
      register: detected_ips
      changed_when: false
      loop: "{{ groups['homeassistant'] }}"

    - name: Store detected IP addresses for initial API access
      set_fact:
        ha_initial_ips: "{{ ha_initial_ips | default({}) | combine({item.item: item.stdout | trim}) }}"
      loop: "{{ detected_ips.results }}"
      when: item.stdout | trim | length > 0

    - name: Show detected HA VM IPs
      debug:
        msg: "{{ item }} – Current IP: {{ ha_initial_ips[item] }} | Target static IP: {{ hostvars[item]['ansible_host'] }}"
      loop: "{{ groups['homeassistant'] }}"
      when: item in (ha_initial_ips | default({}))

    - name: Wait for Home Assistant to become available
      uri:
        url: "http://{{ ha_initial_ips[item] }}:8123/api/"
        method: GET
        status_code: [200, 401]
        timeout: 10
      register: ha_api_check
      retries: 60
      delay: 10
      until: ha_api_check.status in [200, 401]
      loop: "{{ groups['homeassistant'] }}"

    # ------------------------------------------------------------------
    # Host networking
    # ------------------------------------------------------------------
    - name: Add HA VM DNS entry to /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: "\\s+{{ hostvars[item]['ha_vm_name'] }}$"
        line: "{{ hostvars[item]['ansible_host'] }} {{ hostvars[item]['ha_vm_name'] }}"
        state: present
        mode: '0644'
      loop: "{{ groups['homeassistant'] }}"


# ============================================================
# PLAY 2 – Configure Home Assistant via API
# ============================================================
- name: Configure Home Assistant
  hosts: localhost
  become: yes
  gather_facts: no
  tags: [configure]
  vars_files:
    - "../../inventory/group_vars/all.yml"

  tasks:
    # ------------------------------------------------------------------
    # Onboarding
    # ------------------------------------------------------------------
    - name: Check if HA is already onboarded
      uri:
        url: "http://{{ ha_initial_ips[item] }}:8123/api/onboarding"
        method: GET
        status_code: [200]
        timeout: 10
      register: onboarding_status
      failed_when: false
      loop: "{{ groups['homeassistant'] }}"

    # -- Path A: First run – onboarding returns auth_code directly ------
    - name: Complete HA onboarding – create admin user
      uri:
        url: "http://{{ ha_initial_ips[item.item] }}:8123/api/onboarding/users"
        method: POST
        body_format: json
        body:
          client_id: "http://{{ ha_initial_ips[item.item] }}:8123/"
          name: "{{ ha_admin_name }}"
          username: "{{ ha_admin_user }}"
          password: "{{ ha_admin_password }}"
          language: "{{ ha_language }}"
        status_code: [200]
        timeout: 30
      register: onboarding_result
      when:
        - item.status == 200
        - item.json is defined
        - item.json | selectattr('step', 'equalto', 'user') | selectattr('done', 'equalto', false) | list | length > 0
      no_log: true
      loop: "{{ onboarding_status.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Store onboarding auth codes
      set_fact:
        ha_auth_codes: "{{ ha_auth_codes | default({}) | combine({item.item: item.json.auth_code}) }}"
      loop: "{{ onboarding_result.results }}"
      no_log: true
      when:
        - item.skipped is not defined or not item.skipped
        - item.status is defined and item.status == 200

    # -- Path B: Re-run – login flow to obtain auth_code ----------------
    - name: Initiate login flow (re-run)
      uri:
        url: "http://{{ ha_initial_ips[item] }}:8123/auth/login_flow"
        method: POST
        body_format: json
        body:
          client_id: "http://{{ ha_initial_ips[item] }}:8123/"
          handler:
            - "homeassistant"
            - null
          redirect_uri: "http://{{ ha_initial_ips[item] }}:8123/"
        status_code: [200]
        timeout: 30
      register: login_flow
      when: item not in (ha_auth_codes | default({}))
      loop: "{{ groups['homeassistant'] }}"

    - name: Submit credentials to login flow (re-run)
      uri:
        url: "http://{{ ha_initial_ips[item.item] }}:8123/auth/login_flow/{{ item.json.flow_id }}"
        method: POST
        body_format: json
        body:
          username: "{{ ha_admin_user }}"
          password: "{{ ha_admin_password }}"
          client_id: "http://{{ ha_initial_ips[item.item] }}:8123/"
        status_code: [200]
        timeout: 30
      register: login_result
      no_log: true
      when:
        - item.skipped is not defined or not item.skipped
        - item.status is defined and item.status == 200
      loop: "{{ login_flow.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Store login flow auth codes (re-run)
      set_fact:
        ha_auth_codes: "{{ ha_auth_codes | default({}) | combine({_host: item.json.result}) }}"
      vars:
        _host: "{{ item.item.item }}"
      loop: "{{ login_result.results }}"
      no_log: true
      when:
        - item.skipped is not defined or not item.skipped
        - item.status is defined and item.status == 200

    # ------------------------------------------------------------------
    # Exchange auth_code for access + refresh token
    # ------------------------------------------------------------------
    - name: Exchange auth code for tokens
      uri:
        url: "http://{{ ha_initial_ips[item] }}:8123/auth/token"
        method: POST
        body_format: form-urlencoded
        body:
          grant_type: authorization_code
          code: "{{ ha_auth_codes[item] }}"
          client_id: "http://{{ ha_initial_ips[item] }}:8123/"
        status_code: [200]
        timeout: 30
      register: auth_response
      no_log: true
      loop: "{{ groups['homeassistant'] }}"
      when: item in (ha_auth_codes | default({}))

    # The access_token from login flow is short-lived (30 min) but sufficient
    # for the duration of this playbook run.  The refresh_token is persisted
    # to disk so the backup cron can obtain fresh access tokens later.
    #
    # NOTE: The HA Core HTTP proxy (/api/hassio/*) restricts which Supervisor
    # endpoints are accessible – most paths (network, addons, store) are NOT
    # whitelisted and always return 401.  We therefore call Supervisor API
    # endpoints via the WebSocket command "supervisor/api" instead, using the
    # helper script ha_supervisor_api.py.

    - name: Set access token fact for each host
      set_fact:
        ha_tokens: "{{ ha_tokens | default({}) | combine({ item.item: item.json.access_token }) }}"
      loop: "{{ auth_response.results }}"
      no_log: true
      when:
        - item.skipped is not defined or not item.skipped
        - item.status is defined and item.status == 200

    # ------------------------------------------------------------------
    # Persist refresh token for backup scripts (cron)
    # ------------------------------------------------------------------
    - name: Save refresh token to file for backup scripts
      copy:
        dest: "{{ ha_refresh_token_file }}"
        content: "{{ item.json.refresh_token }}"
        mode: '0600'
        owner: root
        group: root
      loop: "{{ auth_response.results }}"
      no_log: true
      when:
        - item.skipped is not defined or not item.skipped
        - item.status is defined and item.status == 200

    # ------------------------------------------------------------------
    # Complete remaining onboarding steps (required for Supervisor API)
    # ------------------------------------------------------------------
    - name: Check remaining onboarding steps
      uri:
        url: "http://{{ ha_initial_ips[item] }}:8123/api/onboarding"
        method: GET
        status_code: [200]
        timeout: 10
      register: remaining_onboarding
      failed_when: false
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens

    - name: Complete core_config onboarding step
      uri:
        url: "http://{{ ha_initial_ips[item.item] }}:8123/api/onboarding/core_config"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_tokens[item.item] }}"
        body_format: json
        body: {}
        status_code: [200]
        timeout: 30
      when:
        - item.status is defined and item.status == 200
        - item.json is defined
        - item.json | selectattr('step', 'equalto', 'core_config') | selectattr('done', 'equalto', false) | list | length > 0
      failed_when: false
      loop: "{{ remaining_onboarding.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Complete analytics onboarding step
      uri:
        url: "http://{{ ha_initial_ips[item.item] }}:8123/api/onboarding/analytics"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_tokens[item.item] }}"
        body_format: json
        body: {}
        status_code: [200]
        timeout: 30
      when:
        - item.status is defined and item.status == 200
        - item.json is defined
        - item.json | selectattr('step', 'equalto', 'analytics') | selectattr('done', 'equalto', false) | list | length > 0
      failed_when: false
      loop: "{{ remaining_onboarding.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Complete integration onboarding step
      uri:
        url: "http://{{ ha_initial_ips[item.item] }}:8123/api/onboarding/integration"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_tokens[item.item] }}"
        body_format: json
        body:
          client_id: "http://{{ ha_initial_ips[item.item] }}:8123/"
          redirect_uri: "http://{{ ha_initial_ips[item.item] }}:8123/"
        status_code: [200]
        timeout: 30
      when:
        - item.status is defined and item.status == 200
        - item.json is defined
        - item.json | selectattr('step', 'equalto', 'integration') | selectattr('done', 'equalto', false) | list | length > 0
      failed_when: false
      loop: "{{ remaining_onboarding.results }}"
      loop_control:
        label: "{{ item.item }}"

    # ------------------------------------------------------------------
    # Deploy WebSocket helper for Supervisor API calls
    # ------------------------------------------------------------------
    - name: Deploy Supervisor API WebSocket helper script
      copy:
        src: files/ha_supervisor_api.py
        dest: /usr/local/bin/ha_supervisor_api.py
        mode: '0755'

    # ------------------------------------------------------------------
    # Configure static IP via Supervisor Network API (WebSocket)
    # ------------------------------------------------------------------
    - name: Configure static IP address
      shell: >-
        echo {{ _ip_body | quote }} |
        python3 /usr/local/bin/ha_supervisor_api.py
        "http://{{ ha_initial_ips[item] }}:8123"
        "{{ ha_tokens[item] }}"
        POST
        /network/interface/default/update
        -
      vars:
        _ip_body: >-
          {{ {"ipv4": {"method": "static",
              "address": [hostvars[item]["ansible_host"] + network_cidr],
              "gateway": network_gateway,
              "nameservers": [network_dns | default(network_gateway)]}} | to_json }}
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens
      # no_log: true  # temporarily disabled for debugging

    - name: Wait for HA to become available on static IP
      uri:
        url: "http://{{ hostvars[item]['ansible_host'] }}:8123/api/"
        method: GET
        status_code: [200, 401]
        timeout: 10
      register: ha_static_check
      retries: 30
      delay: 10
      until: ha_static_check.status in [200, 401]
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens

    - name: Re-authenticate on static IP – initiate login flow
      uri:
        url: "http://{{ hostvars[item]['ansible_host'] }}:8123/auth/login_flow"
        method: POST
        body_format: json
        body:
          client_id: "http://{{ hostvars[item]['ansible_host'] }}:8123/"
          handler:
            - "homeassistant"
            - null
          redirect_uri: "http://{{ hostvars[item]['ansible_host'] }}:8123/"
        status_code: [200]
        timeout: 30
      register: reauth_login_flow
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens

    - name: Re-authenticate on static IP – submit credentials
      uri:
        url: "http://{{ hostvars[item.item]['ansible_host'] }}:8123/auth/login_flow/{{ item.json.flow_id }}"
        method: POST
        body_format: json
        body:
          username: "{{ ha_admin_user }}"
          password: "{{ ha_admin_password }}"
          client_id: "http://{{ hostvars[item.item]['ansible_host'] }}:8123/"
        status_code: [200]
        timeout: 30
      register: reauth_login_result
      no_log: true
      when:
        - item.skipped is not defined or not item.skipped
        - item.status is defined and item.status == 200
      loop: "{{ reauth_login_flow.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Re-authenticate on static IP – exchange auth code for tokens
      uri:
        url: "http://{{ hostvars[_host]['ansible_host'] }}:8123/auth/token"
        method: POST
        body_format: form-urlencoded
        body:
          grant_type: authorization_code
          code: "{{ item.json.result }}"
          client_id: "http://{{ hostvars[_host]['ansible_host'] }}:8123/"
        status_code: [200]
        timeout: 30
      vars:
        _host: "{{ item.item.item }}"
      register: reauth_response
      no_log: true
      when:
        - item.skipped is not defined or not item.skipped
        - item.status is defined and item.status == 200
      loop: "{{ reauth_login_result.results }}"
      loop_control:
        label: "{{ item.item.item }}"

    - name: Update short-lived tokens after IP change
      set_fact:
        ha_tokens: "{{ ha_tokens | combine({ _host: item.json.access_token }) }}"
      vars:
        _host: "{{ item.item.item.item }}"
      loop: "{{ reauth_response.results }}"
      no_log: true
      when:
        - item.skipped is not defined or not item.skipped
        - item.status is defined and item.status == 200

    - name: Update initial IPs to static IP (for any remaining references)
      set_fact:
        ha_initial_ips: "{{ ha_initial_ips | combine({item: hostvars[item]['ansible_host']}) }}"
      loop: "{{ groups['homeassistant'] }}"

    # ------------------------------------------------------------------
    # Install Add-ons via Supervisor API (WebSocket)
    # ------------------------------------------------------------------

    # --- Zigbee2MQTT Add-on ---
    - name: Get current add-on store repositories
      shell: >-
        python3 /usr/local/bin/ha_supervisor_api.py
        "http://{{ hostvars[item]['ansible_host'] }}:8123"
        "{{ ha_tokens[item] }}"
        GET
        /store
      register: ha_store_info
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens
      no_log: true

    - name: Build repository list with Zigbee2MQTT repo added
      set_fact:
        ha_repo_list: >-
          {{
            (ha_store_info.results[0].stdout | from_json).repositories
            | default([])
            | map(attribute='url')
            | list
            | union(['https://github.com/zigbee2mqtt/hassio-zigbee2mqtt'])
          }}
      when: ha_store_info.results | length > 0

    - name: Add Zigbee2MQTT community add-on repository
      shell: >-
        echo '{{ {"repositories": ha_repo_list} | to_json}}'
        | python3 /usr/local/bin/ha_supervisor_api.py
        "http://{{ hostvars[item]['ansible_host'] }}:8123"
        "{{ ha_tokens[item] }}"
        POST
        /store/repositories
        -
      register: add_repo_result
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens

    - name: Reload add-on store after adding repository
      shell: >-
        python3 /usr/local/bin/ha_supervisor_api.py
        "http://{{ hostvars[item]['ansible_host'] }}:8123"
        "{{ ha_tokens[item] }}"
        POST
        /store/reload
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens
      no_log: true

    - name: Wait for store to settle after reload
      pause:
        seconds: 10

    - name: Install Zigbee2MQTT add-on
      shell: >-
        python3 /usr/local/bin/ha_supervisor_api.py
        "http://{{ hostvars[item]['ansible_host'] }}:8123"
        "{{ ha_tokens[item] }}"
        POST
        /store/addons/45df7312_zigbee2mqtt/install
      register: z2m_install
      failed_when:
        - z2m_install.rc != 0
        - "'already installed' not in (z2m_install.stderr | default(''))"
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens
      no_log: true

    - name: Configure Zigbee2MQTT add-on options
      shell: >-
        echo {{ _z2m_opts | quote }} |
        python3 /usr/local/bin/ha_supervisor_api.py
        "http://{{ hostvars[item]['ansible_host'] }}:8123"
        "{{ ha_tokens[item] }}"
        POST
        /addons/45df7312_zigbee2mqtt/options
        -
      vars:
        _z2m_opts: >-
          {{ {"options": {
              "data_path": "/config/zigbee2mqtt",
              "socat": {"enabled": false},
              "mqtt": {
                "server": "mqtt://" + ha_z2m_mqtt_broker_ip + ":" + (mqtt_port | string),
                "user": mqtt_default_user,
                "password": mqtt_default_password,
                "base_topic": "zigbee2mqtt"},
              "serial": {
                "port": ha_z2m_serial_port,
                "adapter": ha_z2m_serial_adapter},
              "frontend": {"port": 8099}}} | to_json }}
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens
      no_log: true

    - name: Start Zigbee2MQTT add-on
      shell: >-
        python3 /usr/local/bin/ha_supervisor_api.py
        "http://{{ hostvars[item]['ansible_host'] }}:8123"
        "{{ ha_tokens[item] }}"
        POST
        /addons/45df7312_zigbee2mqtt/start
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens
      no_log: true

    - name: Enable Zigbee2MQTT add-on auto-start
      shell: >-
        python3 /usr/local/bin/ha_supervisor_api.py
        "http://{{ hostvars[item]['ansible_host'] }}:8123"
        "{{ ha_tokens[item] }}"
        POST
        /addons/45df7312_zigbee2mqtt/options
        '{"boot": "auto"}'
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens
      no_log: true

    # --- Matter Server Add-on ---
    - name: Install Matter Server add-on
      shell: >-
        python3 /usr/local/bin/ha_supervisor_api.py
        "http://{{ hostvars[item]['ansible_host'] }}:8123"
        "{{ ha_tokens[item] }}"
        POST
        /store/addons/core_matter_server/install
      register: matter_install
      failed_when:
        - matter_install.rc != 0
        - "'already installed' not in (matter_install.stderr | default(''))"
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens
      no_log: true

    - name: Start Matter Server add-on
      shell: >-
        python3 /usr/local/bin/ha_supervisor_api.py
        "http://{{ hostvars[item]['ansible_host'] }}:8123"
        "{{ ha_tokens[item] }}"
        POST
        /addons/core_matter_server/start
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens
      no_log: true

    - name: Enable Matter Server add-on auto-start
      shell: >-
        python3 /usr/local/bin/ha_supervisor_api.py
        "http://{{ hostvars[item]['ansible_host'] }}:8123"
        "{{ ha_tokens[item] }}"
        POST
        /addons/core_matter_server/options
        '{"boot": "auto"}'
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens
      no_log: true

    # ------------------------------------------------------------------
    # Configure MQTT Integration in HA
    # ------------------------------------------------------------------
    - name: Configure MQTT integration (external Mosquitto broker)
      uri:
        url: "http://{{ hostvars[item]['ansible_host'] }}:8123/api/config/config_entries/flow"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_tokens[item] }}"
        body_format: json
        body:
          handler: mqtt
          show_advanced_options: false
        status_code: [200]
        timeout: 30
      register: mqtt_flow
      failed_when: false
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens

    - name: Select 'broker' option in MQTT config flow menu
      uri:
        url: "http://{{ hostvars[item.item]['ansible_host'] }}:8123/api/config/config_entries/flow/{{ item.json.flow_id }}"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_tokens[item.item] }}"
        body_format: json
        body:
          next_step_id: broker
        status_code: [200]
        timeout: 30
      register: mqtt_broker_step
      failed_when: false
      when:
        - item.status == 200
        - item.json.type | default('') == 'menu'
        - item.item in ha_tokens
      loop: "{{ mqtt_flow.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Submit MQTT broker configuration
      uri:
        url: "http://{{ hostvars[item.item]['ansible_host'] }}:8123/api/config/config_entries/flow/{{ item.json.flow_id }}"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_tokens[item.item] }}"
        body_format: json
        body:
          broker: "{{ ha_z2m_mqtt_broker_ip }}"
          port: "{{ mqtt_port | int }}"
          username: "{{ mqtt_default_user }}"
          password: "{{ mqtt_default_password }}"
          discovery: true
        status_code: [200]
        timeout: 30
      when:
        - item.status == 200
        - item.item in ha_tokens
      no_log: true
      loop: "{{ mqtt_broker_step.results }}"
      loop_control:
        label: "{{ item.item }}"

    # ------------------------------------------------------------------
    # Verification
    # ------------------------------------------------------------------
    - name: Verify Home Assistant is healthy
      uri:
        url: "http://{{ hostvars[item]['ansible_host'] }}:8123/api/"
        method: GET
        headers:
          Authorization: "Bearer {{ ha_tokens[item] }}"
        status_code: [200]
        timeout: 10
      register: ha_final_check
      loop: "{{ groups['homeassistant'] }}"
      when: item in ha_tokens

    - name: Print HA status
      debug:
        msg: "HA ({{ item.item }}) running at http://{{ hostvars[item.item]['ansible_host'] }}:8123 – Message: {{ item.json.message }}"
      loop: "{{ ha_final_check.results }}"
      when: item.status is defined and item.status == 200


# ============================================================
# PLAY 3 – Set up backup to NAS (runs on Proxmox host)
# ============================================================
- name: Setup Home Assistant Backup to NAS
  hosts: localhost
  become: yes
  gather_facts: no
  tags: [backup]
  vars_files:
    - "../../inventory/group_vars/all.yml"

  tasks:
    # ------------------------------------------------------------------
    # Ensure backup directory on NAS exists
    # ------------------------------------------------------------------
    - name: Ensure HA backup directory on NAS exists
      file:
        path: "{{ nas_backup_mount }}/homeassistant"
        state: directory
        owner: root
        group: root
        mode: '0750'

    # ------------------------------------------------------------------
    # Backup script
    # ------------------------------------------------------------------
    - name: Deploy HA backup script
      template:
        src: templates/ha_backup.sh.j2
        dest: "{{ ha_backup_script_path }}"
        mode: '0750'

    # ------------------------------------------------------------------
    # Cron jobs
    # ------------------------------------------------------------------
    - name: Set up periodic HA backup via cron
      cron:
        name: "Home Assistant backup to NAS"
        minute: "{{ ha_backup_cron_minute }}"
        hour: "{{ ha_backup_cron_hour }}"
        job: "{{ ha_backup_script_path }} 2>&1 | logger -t ha-backup-cron"
        user: root
        state: present
