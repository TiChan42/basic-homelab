#!/bin/bash
# ============================================
# Node-RED Backup Script – managed by Ansible
# Creates a validated tar.gz archive of Node-RED
# data on NAS with numbered rotation (0 = newest).
# ============================================
set -euo pipefail

BACKUP_DIR="{{ nas_backup_mount }}/nodered"
DATA_DIR="{{ nodered_data_dir }}"
LOG_TAG="nodered-backup"
MIN_BACKUP_SIZE={{ nodered_backup_min_size }}
KEEP_COUNT={{ nodered_backup_keep_count }}

TMP_FILE="$BACKUP_DIR/.nodered_backup_creating.tar.gz"
BACKUP_PREFIX="$BACKUP_DIR/nodered_backup"

logger -t "$LOG_TAG" "Starting Node-RED backup..."

# 1. Check NFS mount is available
if ! mountpoint -q "{{ nas_mount }}"; then
  logger -t "$LOG_TAG" "ERROR: NAS mount not available at {{ nas_mount }}"
  exit 1
fi

mkdir -p "$BACKUP_DIR"

# 2. Create tar.gz archive to temporary file (exclude node_modules – reinstalled on restore)
if [ ! -d "$DATA_DIR" ]; then
  logger -t "$LOG_TAG" "ERROR: Data directory $DATA_DIR does not exist."
  exit 1
fi

tar -czf "$TMP_FILE" \
  --exclude='node_modules' \
  --exclude='.npm' \
  --exclude='*.log' \
  "$DATA_DIR" 2>/dev/null

# 3. Validate: file exists and has content
if [ ! -s "$TMP_FILE" ]; then
  logger -t "$LOG_TAG" "ERROR: Created archive is empty. Keeping previous backups."
  rm -f "$TMP_FILE"
  exit 1
fi

# 4. Validate: minimum size
FILE_SIZE=$(stat -c%s "$TMP_FILE" 2>/dev/null || stat -f%z "$TMP_FILE" 2>/dev/null || echo "0")
if [ "$FILE_SIZE" -lt "$MIN_BACKUP_SIZE" ]; then
  logger -t "$LOG_TAG" "ERROR: Backup too small (${FILE_SIZE} bytes, min ${MIN_BACKUP_SIZE}). Keeping previous backups."
  rm -f "$TMP_FILE"
  exit 1
fi

# 5. Validate: valid tar.gz archive
if ! tar -tzf "$TMP_FILE" > /dev/null 2>&1; then
  logger -t "$LOG_TAG" "ERROR: Created file is not a valid tar.gz archive. Keeping previous backups."
  rm -f "$TMP_FILE"
  exit 1
fi

# 5b. Overwrite protection: skip if new backup is significantly smaller than existing
if [ -f "${BACKUP_PREFIX}.0.tar.gz" ]; then
  EXISTING_SIZE=$(stat -c%s "${BACKUP_PREFIX}.0.tar.gz" 2>/dev/null || echo "0")
  if [ "$EXISTING_SIZE" -gt "$MIN_BACKUP_SIZE" ] && [ "$FILE_SIZE" -lt $(( EXISTING_SIZE / 2 )) ]; then
    logger -t "$LOG_TAG" "WARNING: New backup (${FILE_SIZE} bytes) is less than half the existing (${EXISTING_SIZE} bytes). Skipping to prevent data loss."
    rm -f "$TMP_FILE"
    exit 0
  fi
fi

# 6. All checks passed – rotate numbered backups
#    Delete oldest, shift N-1 → N, ..., 1 → 2, 0 → 1, new → 0
rm -f "${BACKUP_PREFIX}.$((KEEP_COUNT - 1)).tar.gz"

for (( i = KEEP_COUNT - 2; i >= 0; i-- )); do
  if [ -f "${BACKUP_PREFIX}.${i}.tar.gz" ]; then
    mv -f "${BACKUP_PREFIX}.${i}.tar.gz" "${BACKUP_PREFIX}.$((i + 1)).tar.gz"
  fi
done

mv -f "$TMP_FILE" "${BACKUP_PREFIX}.0.tar.gz"

# 7. Metadata
echo "backup_date=$(date -Iseconds)" > "$BACKUP_DIR/backup_meta.txt"
echo "hostname=$(hostname)" >> "$BACKUP_DIR/backup_meta.txt"
echo "file_size=${FILE_SIZE}" >> "$BACKUP_DIR/backup_meta.txt"
echo "keep_count=${KEEP_COUNT}" >> "$BACKUP_DIR/backup_meta.txt"

logger -t "$LOG_TAG" "Node-RED backup completed successfully (${FILE_SIZE} bytes) -> ${BACKUP_PREFIX}.0.tar.gz"
