---
# tasks/install_nodered.yml – Node.js + Node-RED + Extra-Nodes installieren
#
# Läuft im Container (hosts: nodered).
# Installiert immer die neueste stabile Version via npm.

# ------------------------------------------------------------------
# System-Abhängigkeiten
# ------------------------------------------------------------------
- name: Install system dependencies
  apt:
    name:
      - git
      - curl
      - gnupg
      - nfs-common
      - build-essential
      - python3
    state: present
    update_cache: yes

# ------------------------------------------------------------------
# Node.js (via NodeSource)
# ------------------------------------------------------------------
- name: Add NodeSource GPG keyring
  shell: |
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key \
      | gpg --dearmor -o /usr/share/keyrings/nodesource.gpg
  args:
    creates: /usr/share/keyrings/nodesource.gpg

- name: Add Node.js repository
  copy:
    dest: /etc/apt/sources.list.d/nodesource.list
    content: "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ nodered_node_version }}.x nodistro main\n"
    mode: '0644'
  register: nodesource_repo

- name: Install Node.js
  apt:
    name: nodejs
    state: latest
    update_cache: yes

# ------------------------------------------------------------------
# Node-RED (global, neueste stabile Version)
# ------------------------------------------------------------------
- name: Install/update Node-RED globally via npm
  npm:
    name: node-red
    global: yes
    state: latest

- name: Ensure Node-RED data directory exists
  file:
    path: "{{ nodered_data_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0750'

# ------------------------------------------------------------------
# Extra-Nodes (ins Node-RED userDir)
# ------------------------------------------------------------------
- name: Install/update additional Node-RED modules
  npm:
    name: "{{ item }}"
    path: "{{ nodered_data_dir }}"
    state: latest
  loop: "{{ nodered_extra_nodes }}"
