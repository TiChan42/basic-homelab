---
# ==============================================================================
# Playbook: Services - MQTT Broker (Mosquitto)
# Description: Provisions a Proxmox LXC container and deploys an Eclipse
#              Mosquitto MQTT broker with automated NAS backup/restore.
#
# Structure:
#   main.yml                          ← Orchestrator (this file)
#   tasks/
#     provision_container.yml         ← LXC erstellen, starten, DNS, Port-Forwarding
#     configure_networking.yml        ← Statische IP via Netplan
#     install_mosquitto.yml           ← Mosquitto + Tools installieren
#     restore_backup.yml              ← NAS-Backup prüfen & wiederherstellen
#     configure_mosquitto.yml         ← Verzeichnisse, Config, Authentifizierung
#     setup_backup.yml                ← Backup/Restore-Scripts, Cron, Systemd
#     verify_service.yml              ← Mosquitto starten, Port prüfen, Status
#   templates/
#     mosquitto.conf.j2               ← Mosquitto-Konfiguration
#     netplan.yaml.j2                 ← Statische Netzwerk-Konfiguration
#     mqtt_backup.sh.j2               ← Backup-Script
#     mqtt_restore.sh.j2              ← Restore-Script
#     mqtt-restore.service.j2         ← Systemd restore-on-boot
#
# Inventory Requirements (per host in 'mqtt_brokers' group):
#   - mqtt_container_id               (unique Proxmox VMID)
#   - ansible_host                    (static IP for the container)
# ==============================================================================

# ============================================================
# PLAY 1 – Provision the LXC container on the Proxmox host
# ============================================================
- name: Provision Proxmox Container for MQTT Broker
  hosts: localhost
  become: yes
  gather_facts: yes
  tags: [provision]
  vars_files:
    - "../../inventory/group_vars/all.yml"

  tasks:
    - name: Provision & configure MQTT container
      include_tasks: tasks/provision_container.yml

# ============================================================
# PLAY 2 – Deploy & configure Mosquitto inside the container
# ============================================================
- name: Deploy MQTT Broker (Mosquitto)
  hosts: mqtt_brokers
  become: yes
  gather_facts: yes
  tags: [deploy]
  vars_files:
    - "../../inventory/group_vars/all.yml"

  tasks:
    - name: Configure static networking
      include_tasks: tasks/configure_networking.yml

    - name: Install Mosquitto packages
      include_tasks: tasks/install_mosquitto.yml

    - name: Restore backup from NAS (if needed)
      include_tasks: tasks/restore_backup.yml

    - name: Configure Mosquitto (dirs, config, auth)
      include_tasks: tasks/configure_mosquitto.yml

    - name: Setup backup & restore infrastructure
      include_tasks: tasks/setup_backup.yml

    - name: Start & verify Mosquitto service
      include_tasks: tasks/verify_service.yml

  handlers:
    - name: Restart Mosquitto
      systemd:
        name: mosquitto
        state: restarted

    - name: Reload systemd
      systemd:
        daemon_reload: yes
