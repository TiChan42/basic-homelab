#!/bin/bash
# ============================================
# MQTT Broker Backup Script – managed by Ansible
# Creates a validated tar.gz archive of Mosquitto
# data on NAS with numbered rotation (0 = newest).
# ============================================
set -euo pipefail

BACKUP_DIR="{{ nas_backup_mount }}/mqtt-broker"
DATA_DIR="{{ mqtt_data_dir }}"
CONF_FILE="/etc/mosquitto/mosquitto.conf"
PASSWD_FILE="{{ mqtt_password_file }}"
LOG_TAG="mqtt-backup"
MIN_BACKUP_SIZE={{ mqtt_backup_min_size }}
KEEP_COUNT={{ mqtt_backup_keep_count }}

TMP_FILE="$BACKUP_DIR/.mqtt_backup_creating.tar.gz"
BACKUP_PREFIX="$BACKUP_DIR/mqtt_backup"

logger -t "$LOG_TAG" "Starting MQTT backup..."

# 1. Check NFS mount is available
if ! mountpoint -q "{{ nas_mount }}"; then
  logger -t "$LOG_TAG" "ERROR: NAS mount not available at {{ nas_mount }}"
  exit 1
fi

mkdir -p "$BACKUP_DIR"

# 1b. Overwrite protection: skip if password file is empty but existing backup has data
if [ -f "$PASSWD_FILE" ]; then
  PASSWD_ENTRIES=$(grep -c . "$PASSWD_FILE" 2>/dev/null || echo "0")
  if [ "$PASSWD_ENTRIES" -eq 0 ] && [ -f "${BACKUP_PREFIX}.0.tar.gz" ]; then
    OLD_ENTRIES=$(tar -xzf "${BACKUP_PREFIX}.0.tar.gz" -O "etc/mosquitto/passwd" 2>/dev/null | grep -c . 2>/dev/null || echo "0")
    if [ "${OLD_ENTRIES:-0}" -gt 0 ]; then
      logger -t "$LOG_TAG" "WARNING: Password file is empty but existing backup has ${OLD_ENTRIES} entries. Skipping backup to prevent data loss."
      exit 0
    fi
  fi
fi

# 2. Stop Mosquitto to ensure data consistency
systemctl stop mosquitto
sleep 2

# 3. Create tar.gz archive to temporary file
ARCHIVE_CONTENTS=()

if [ -f "$CONF_FILE" ]; then
  ARCHIVE_CONTENTS+=("$CONF_FILE")
fi

if [ -d "$DATA_DIR" ]; then
  ARCHIVE_CONTENTS+=("$DATA_DIR")
fi

if [ -f "$PASSWD_FILE" ]; then
  ARCHIVE_CONTENTS+=("$PASSWD_FILE")
fi

if [ {% raw %}${#ARCHIVE_CONTENTS[@]}{% endraw %} -eq 0 ]; then
  logger -t "$LOG_TAG" "ERROR: No files to backup. Restarting Mosquitto."
  systemctl start mosquitto
  exit 1
fi

tar -czf "$TMP_FILE" "${ARCHIVE_CONTENTS[@]}" 2>/dev/null

# 4. Restart Mosquitto as quickly as possible
systemctl start mosquitto

# 5. Validate: file exists and has content
if [ ! -s "$TMP_FILE" ]; then
  logger -t "$LOG_TAG" "ERROR: Created archive is empty. Keeping previous backups."
  rm -f "$TMP_FILE"
  exit 1
fi

# 6. Validate: minimum size
FILE_SIZE=$(stat -c%s "$TMP_FILE" 2>/dev/null || stat -f%z "$TMP_FILE" 2>/dev/null || echo "0")
if [ "$FILE_SIZE" -lt "$MIN_BACKUP_SIZE" ]; then
  logger -t "$LOG_TAG" "ERROR: Backup too small (${FILE_SIZE} bytes, min ${MIN_BACKUP_SIZE}). Keeping previous backups."
  rm -f "$TMP_FILE"
  exit 1
fi

# 7. Validate: valid tar.gz archive
if ! tar -tzf "$TMP_FILE" > /dev/null 2>&1; then
  logger -t "$LOG_TAG" "ERROR: Created file is not a valid tar.gz archive. Keeping previous backups."
  rm -f "$TMP_FILE"
  exit 1
fi

# 8. All checks passed – rotate numbered backups
#    Delete oldest, shift N-1 → N, ..., 1 → 2, 0 → 1, new → 0
rm -f "${BACKUP_PREFIX}.$((KEEP_COUNT - 1)).tar.gz"

for (( i = KEEP_COUNT - 2; i >= 0; i-- )); do
  if [ -f "${BACKUP_PREFIX}.${i}.tar.gz" ]; then
    mv -f "${BACKUP_PREFIX}.${i}.tar.gz" "${BACKUP_PREFIX}.$((i + 1)).tar.gz"
  fi
done

mv -f "$TMP_FILE" "${BACKUP_PREFIX}.0.tar.gz"

# 9. Metadata
echo "backup_date=$(date -Iseconds)" > "$BACKUP_DIR/backup_meta.txt"
echo "hostname=$(hostname)" >> "$BACKUP_DIR/backup_meta.txt"
echo "file_size=${FILE_SIZE}" >> "$BACKUP_DIR/backup_meta.txt"
echo "keep_count=${KEEP_COUNT}" >> "$BACKUP_DIR/backup_meta.txt"

logger -t "$LOG_TAG" "MQTT backup completed successfully (${FILE_SIZE} bytes) -> ${BACKUP_PREFIX}.0.tar.gz"
