---
# tasks/configure_mosquitto.yml – Verzeichnisse, Config-Template & Authentifizierung
#
# Läuft im Container (hosts: mqtt_brokers).

# ------------------------------------------------------------------
# Verzeichnisse
# ------------------------------------------------------------------
- name: Ensure Mosquitto data directory exists
  file:
    path: "{{ mqtt_data_dir }}"
    state: directory
    owner: mosquitto
    group: mosquitto
    mode: '0750'

- name: Ensure Mosquitto log directory exists
  file:
    path: "{{ mqtt_log_dir }}"
    state: directory
    owner: mosquitto
    group: mosquitto
    mode: '0750'

# ------------------------------------------------------------------
# Konfiguration
# ------------------------------------------------------------------
- name: Deploy Mosquitto configuration
  template:
    src: templates/mosquitto.conf.j2
    dest: /etc/mosquitto/mosquitto.conf
    owner: mosquitto
    group: mosquitto
    mode: '0640'
  notify: Restart Mosquitto

# ------------------------------------------------------------------
# Authentifizierung – Passwörter werden bei jedem Lauf aktualisiert
# ------------------------------------------------------------------
- name: Check if password file already exists
  stat:
    path: "{{ mqtt_password_file }}"
  register: passwd_file

- name: Create initial password file with admin user
  shell: |
    mosquitto_passwd -b -c {{ mqtt_password_file }} {{ mqtt_admin_user | quote }} {{ mqtt_admin_password | quote }}
  when:
    - mqtt_auth_enabled | default(true) | bool
    - not passwd_file.stat.exists
  no_log: true

- name: Ensure MQTT admin user password is current
  shell: |
    mosquitto_passwd -b {{ mqtt_password_file }} {{ mqtt_admin_user | quote }} {{ mqtt_admin_password | quote }}
  when:
    - mqtt_auth_enabled | default(true) | bool
    - passwd_file.stat.exists
  no_log: true
  notify: Restart Mosquitto

- name: Ensure MQTT machine user password is current
  shell: |
    mosquitto_passwd -b {{ mqtt_password_file }} {{ mqtt_machine_user | quote }} {{ mqtt_machine_password | quote }}
  when:
    - mqtt_auth_enabled | default(true) | bool
  no_log: true
  notify: Restart Mosquitto

- name: Ensure MQTT default user password is current
  shell: |
    mosquitto_passwd -b {{ mqtt_password_file }} {{ default_user | quote }} {{ default_password | quote }}
  when:
    - mqtt_auth_enabled | default(true) | bool
  no_log: true
  notify: Restart Mosquitto

- name: Set password file permissions
  file:
    path: "{{ mqtt_password_file }}"
    owner: mosquitto
    group: mosquitto
    mode: '0600'
  when: mqtt_auth_enabled | default(true) | bool
