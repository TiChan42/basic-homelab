---
# tasks/restore_backup.yml – NAS-Backup prüfen & wiederherstellen
#
# Läuft im Container (hosts: mqtt_brokers).
# Idempotent: Wird übersprungen, wenn MQTT bereits konfiguriert ist.
# Indikator: Passwortdatei existiert nur nach configure_mosquitto.yml,
# NICHT nach bloßer Paketinstallation (mosquitto.db wird von APT-Autostart erzeugt).

- name: Ensure MQTT backup directory on NAS exists
  file:
    path: "{{ nas_backup_mount }}/mqtt-broker"
    state: directory
    mode: '0777'

- name: Stop Mosquitto before restore check (in case of re-run)
  systemd:
    name: mosquitto
    state: stopped
  failed_when: false

- name: Check if MQTT was previously configured (password file as indicator)
  stat:
    path: "{{ mqtt_password_file }}"
  register: mqtt_configured

- name: Find available NAS backup archives (numbered, 0 = newest)
  stat:
    path: "{{ nas_backup_mount }}/mqtt-broker/mqtt_backup.{{ item }}.tar.gz"
  register: nas_backup_candidates
  loop: "{{ range(0, mqtt_backup_keep_count) | list }}"
  when: not mqtt_configured.stat.exists

- name: Set best available backup to restore from
  set_fact:
    mqtt_restore_archive: >-
      {{ (nas_backup_candidates.results | default([])
          | selectattr('stat.exists', 'defined')
          | selectattr('stat.exists')
          | first).stat.path | default('') }}
  when: not mqtt_configured.stat.exists

- name: Stop Mosquitto before restore
  systemd:
    name: mosquitto
    state: stopped
  when:
    - not mqtt_configured.stat.exists
    - mqtt_restore_archive | default('') | length > 0
  ignore_errors: true

- name: Restore Mosquitto data from NAS backup archive
  unarchive:
    src: "{{ mqtt_restore_archive }}"
    dest: /
    remote_src: yes
  when:
    - not mqtt_configured.stat.exists
    - mqtt_restore_archive | default('') | length > 0

- name: Fix ownership after restore
  file:
    path: "{{ item }}"
    owner: mosquitto
    group: mosquitto
    recurse: "{{ item == mqtt_data_dir }}"
  loop:
    - "{{ mqtt_data_dir }}"
    - "/etc/mosquitto/mosquitto.conf"
  when:
    - not mqtt_configured.stat.exists
    - mqtt_restore_archive | default('') | length > 0
  ignore_errors: true
