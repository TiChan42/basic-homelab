---
# ==============================================================================
# Tasks: Detect VM IP and wait for HA API
# ==============================================================================

- name: Wait for QEMU Guest Agent to become ready
  command: "qm guest cmd {{ hostvars[item]['service_id'] }} ping"
  register: agent_ping
  retries: 30
  delay: 10
  until: agent_ping.rc == 0
  changed_when: false
  loop: "{{ groups['homeassistant'] }}"

- name: Detect VM IP address via QEMU Guest Agent
  shell: >-
    qm guest cmd {{ hostvars[item]['service_id'] }} network-get-interfaces
    | jq -r '[.[] | select(.name != "lo") | ."ip-addresses"[]?
    | select(."ip-address-type" == "ipv4")] | .[0]."ip-address"'
  register: detected_ips
  changed_when: false
  loop: "{{ groups['homeassistant'] }}"

- name: Store detected IP addresses for initial API access
  set_fact:
    ha_initial_ips: "{{ ha_initial_ips | default({}) | combine({item.item: item.stdout | trim}) }}"
  loop: "{{ detected_ips.results }}"
  when: item.stdout | trim | length > 0

- name: Show detected HA VM IPs
  debug:
    msg: "{{ item }} â€“ Current IP: {{ ha_initial_ips[item] }} | Target static IP: {{ hostvars[item]['ansible_host'] }}"
  loop: "{{ groups['homeassistant'] }}"
  when: item in (ha_initial_ips | default({}))

- name: Wait for Home Assistant API to become available
  uri:
    url: "http://{{ ha_initial_ips[item] }}:{{ ha_port | default('8123') }}/api/"
    method: GET
    status_code: [200, 401]
    timeout: 10
  register: ha_api_check
  retries: 60
  delay: 10
  until: ha_api_check.status in [200, 401]
  loop: "{{ groups['homeassistant'] }}"

- name: Add HA VM DNS entry to /etc/hosts
  lineinfile:
    path: /etc/hosts
    regexp: "\\s+{{ item }}$"
    line: "{{ hostvars[item]['ansible_host'] }} {{ item }}"
    state: present
    mode: '0644'
  loop: "{{ groups['homeassistant'] }}"
