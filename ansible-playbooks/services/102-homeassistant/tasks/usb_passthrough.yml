---
# ==============================================================================
# Tasks: USB Passthrough â€“ Auto-detect and pass through Zigbee dongles
# ==============================================================================

- name: Scan USB bus for connected devices
  command: lsusb
  register: lsusb_output
  changed_when: false

- name: Auto-detect known Zigbee/USB dongles
  set_fact:
    ha_detected_usb_devices: >-
      {{ ha_known_zigbee_dongles
         | selectattr('vid_pid', 'in', lsusb_output.stdout)
         | map(attribute='vid_pid')
         | list }}

- name: Show detected USB dongles
  debug:
    msg: |
      Detected {{ ha_detected_usb_devices | length }} known dongle(s): {{ ha_detected_usb_devices | join(', ') }}
      {% if ha_detected_usb_devices | length == 0 %}
      WARNING: No known Zigbee dongle found!
      Known IDs searched: {{ ha_known_zigbee_dongles | map(attribute='vid_pid') | join(', ') }}
      Connected USB: {{ lsusb_output.stdout_lines | join(', ') }}
      {% endif %}

- name: Merge auto-detected with manually specified USB devices
  set_fact:
    ha_usb_final_devices: >-
      {{ (ha_detected_usb_devices + ha_usb_extra_devices) | unique | list }}

- name: Configure USB device passthrough for detected dongles
  command: >-
    qm set {{ hostvars[usb_passthrough_item.0]['service_id'] }}
    --usb{{ ansible_loop.index0 }} host={{ usb_passthrough_item.1 }},usb3=1
  loop: "{{ groups['homeassistant'] | product(ha_usb_final_devices) | list }}"
  loop_control:
    loop_var: usb_passthrough_item
    label: "VM {{ hostvars[usb_passthrough_item.0]['service_id'] }} <- USB {{ usb_passthrough_item.1 }}"
    extended: true
  when: ha_usb_final_devices | length > 0

- name: Warn if no USB devices found and none manually specified
  debug:
    msg: >
      WARNING: No USB devices passed through to HA VM!
      Plug in your Zigbee dongle and re-run, or add the device ID
      manually to 'ha_usb_extra_devices' in group_vars/all.yml.
      Find IDs with: lsusb
  when: ha_usb_final_devices | length == 0
