---
# ==============================================================================
# Tasks: HA Onboarding & Authentication
# ==============================================================================
# Handles both first-run (onboarding) and re-run (login flow) scenarios.
# Produces: ha_tokens dict with access tokens per host.
# ==============================================================================

# ------------------------------------------------------------------
# Check onboarding state
# ------------------------------------------------------------------
- name: Check if HA is already onboarded
  uri:
    url: "http://{{ ha_initial_ips[item] }}:{{ ha_port | default('8123') }}/api/onboarding"
    method: GET
    status_code: [200]
    timeout: 10
  register: onboarding_status
  failed_when: false
  loop: "{{ groups['homeassistant'] }}"

# ------------------------------------------------------------------
# Path A: First run – onboarding creates admin user & returns auth_code
# ------------------------------------------------------------------
- name: Complete HA onboarding – create admin user
  uri:
    url: "http://{{ ha_initial_ips[item.item] }}:{{ ha_port | default('8123') }}/api/onboarding/users"
    method: POST
    body_format: json
    body:
      client_id: "http://{{ ha_initial_ips[item.item] }}:{{ ha_port | default('8123') }}/"
      name: "{{ ha_admin_name }}"
      username: "{{ ha_admin_user }}"
      password: "{{ ha_admin_password }}"
      language: "{{ ha_language }}"
    status_code: [200]
    timeout: 30
  register: onboarding_result
  when:
    - item.status == 200
    - item.json is defined
    - item.json | selectattr('step', 'equalto', 'user') | selectattr('done', 'equalto', false) | list | length > 0
  no_log: true
  loop: "{{ onboarding_status.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Store onboarding auth codes
  set_fact:
    ha_auth_codes: "{{ ha_auth_codes | default({}) | combine({_host: item.json.auth_code}) }}"
  vars:
    _host: "{{ item.item.item }}"
  loop: "{{ onboarding_result.results }}"
  no_log: true
  when:
    - item.skipped is not defined or not item.skipped
    - item.status is defined and item.status == 200

# ------------------------------------------------------------------
# Path B: Re-run – obtain auth_code via login flow
# ------------------------------------------------------------------
- name: Initiate login flow
  uri:
    url: "http://{{ ha_initial_ips[item] }}:{{ ha_port | default('8123') }}/auth/login_flow"
    method: POST
    headers:
      Origin: "http://{{ ha_initial_ips[item] }}:{{ ha_port | default('8123') }}"
    body_format: json
    body:
      client_id: "http://{{ ha_initial_ips[item] }}:{{ ha_port | default('8123') }}/"
      handler:
        - "homeassistant"
        - null
      redirect_uri: "http://{{ ha_initial_ips[item] }}:{{ ha_port | default('8123') }}/"
    status_code: [200]
    timeout: 30
  register: login_flow
  when: item not in (ha_auth_codes | default({}))
  loop: "{{ groups['homeassistant'] }}"

- name: Submit credentials to login flow
  uri:
    url: "http://{{ ha_initial_ips[item.item] }}:{{ ha_port | default('8123') }}/auth/login_flow/{{ item.json.flow_id }}"
    method: POST
    headers:
      Origin: "http://{{ ha_initial_ips[item.item] }}:{{ ha_port | default('8123') }}"
    body_format: json
    body:
      username: "{{ ha_admin_user }}"
      password: "{{ ha_admin_password }}"
      client_id: "http://{{ ha_initial_ips[item.item] }}:{{ ha_port | default('8123') }}/"
    status_code: [200]
    timeout: 30
  register: login_result
  no_log: true
  when:
    - item.skipped is not defined or not item.skipped
    - item.status is defined and item.status == 200
  loop: "{{ login_flow.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Store login flow auth codes
  set_fact:
    ha_auth_codes: "{{ ha_auth_codes | default({}) | combine({_host: item.json.result}) }}"
  vars:
    _host: "{{ item.item.item }}"
  loop: "{{ login_result.results }}"
  no_log: true
  when:
    - item.skipped is not defined or not item.skipped
    - item.status is defined and item.status == 200

# ------------------------------------------------------------------
# Exchange auth_code for access + refresh tokens
# ------------------------------------------------------------------
- name: Exchange auth code for tokens
  uri:
    url: "http://{{ ha_initial_ips[item] }}:{{ ha_port | default('8123') }}/auth/token"
    method: POST
    body_format: form-urlencoded
    body:
      grant_type: authorization_code
      code: "{{ ha_auth_codes[item] }}"
      client_id: "http://{{ ha_initial_ips[item] }}:{{ ha_port | default('8123') }}/"
    status_code: [200]
    timeout: 30
  register: auth_response
  no_log: true
  loop: "{{ groups['homeassistant'] }}"
  when: item in (ha_auth_codes | default({}))

- name: Set access token fact for each host
  set_fact:
    ha_tokens: "{{ ha_tokens | default({}) | combine({ item.item: item.json.access_token }) }}"
  loop: "{{ auth_response.results }}"
  no_log: true
  when:
    - item.skipped is not defined or not item.skipped
    - item.status is defined and item.status == 200

- name: Save refresh token to file for backup scripts
  copy:
    dest: "{{ ha_refresh_token_file }}"
    content: "{{ item.json.refresh_token }}"
    mode: '0600'
    owner: root
    group: root
  loop: "{{ auth_response.results }}"
  no_log: true
  when:
    - item.skipped is not defined or not item.skipped
    - item.status is defined and item.status == 200

# ------------------------------------------------------------------
# Complete remaining onboarding steps (idempotent – skips if done)
# ------------------------------------------------------------------
- name: Check remaining onboarding steps
  uri:
    url: "http://{{ ha_initial_ips[item] }}:{{ ha_port | default('8123') }}/api/onboarding"
    method: GET
    status_code: [200]
    timeout: 10
  register: remaining_onboarding
  failed_when: false
  loop: "{{ groups['homeassistant'] }}"
  when: item in ha_tokens

- name: Complete core_config onboarding step
  uri:
    url: "http://{{ ha_initial_ips[item.item] }}:{{ ha_port | default('8123') }}/api/onboarding/core_config"
    method: POST
    headers:
      Authorization: "Bearer {{ ha_tokens[item.item] }}"
    body_format: json
    body: {}
    status_code: [200]
    timeout: 30
  when:
    - item.status is defined and item.status == 200
    - item.json is defined
    - item.json | selectattr('step', 'equalto', 'core_config') | selectattr('done', 'equalto', false) | list | length > 0
  failed_when: false
  loop: "{{ remaining_onboarding.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Complete analytics onboarding step
  uri:
    url: "http://{{ ha_initial_ips[item.item] }}:{{ ha_port | default('8123') }}/api/onboarding/analytics"
    method: POST
    headers:
      Authorization: "Bearer {{ ha_tokens[item.item] }}"
    body_format: json
    body: {}
    status_code: [200]
    timeout: 30
  when:
    - item.status is defined and item.status == 200
    - item.json is defined
    - item.json | selectattr('step', 'equalto', 'analytics') | selectattr('done', 'equalto', false) | list | length > 0
  failed_when: false
  loop: "{{ remaining_onboarding.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Complete integration onboarding step
  uri:
    url: "http://{{ ha_initial_ips[item.item] }}:{{ ha_port | default('8123') }}/api/onboarding/integration"
    method: POST
    headers:
      Authorization: "Bearer {{ ha_tokens[item.item] }}"
    body_format: json
    body:
      client_id: "http://{{ ha_initial_ips[item.item] }}:{{ ha_port | default('8123') }}/"
      redirect_uri: "http://{{ ha_initial_ips[item.item] }}:{{ ha_port | default('8123') }}/"
    status_code: [200]
    timeout: 30
  when:
    - item.status is defined and item.status == 200
    - item.json is defined
    - item.json | selectattr('step', 'equalto', 'integration') | selectattr('done', 'equalto', false) | list | length > 0
  failed_when: false
  loop: "{{ remaining_onboarding.results }}"
  loop_control:
    label: "{{ item.item }}"
