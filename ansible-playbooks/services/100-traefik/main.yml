---
# ==============================================================================
# Playbook: Services - Traefik Reverse Proxy
# Description: Provisions a Proxmox LXC container running Traefik as the
#              central reverse proxy for all homelab web services.
#              Handles HTTP (80) → HTTPS (443) redirection, automatic
#              Let's Encrypt certificates (or self-signed), and DNS-based
#              routing to backend services.
#
# Process:
# 1. Proxmox Container Provisioning (localhost):
#    - Creates the Traefik LXC container.
#    - Sets up port forwarding for ports 80, 443, and the Traefik dashboard.
#
# 2. Traefik Deployment (Container):
#    - Configures static networking (Netplan).
#    - Installs Traefik from the official binary.
#    - Deploys static config (traefik.yml) and dynamic config (services.yml).
#    - Configures and starts the systemd service.
#
# Inventory Requirements (in 'traefik' group):
#   - service_id                    (unique Proxmox VMID)
#   - service_name                  (canonical name, e.g. "traefik")
#   - ansible_host                  (static IP for the container)
# ==============================================================================

# ============================================================
# PLAY 1 – Provision the Traefik LXC on the Proxmox host
# ============================================================
- name: Provision Traefik Reverse Proxy Container
  hosts: localhost
  become: yes
  gather_facts: yes
  tags: [provision]
  vars_files:
    - "../../inventory/group_vars/all.yml"

  tasks:
    - name: Include provisioning tasks
      include_tasks: tasks/provision_container.yml

# ============================================================
# PLAY 2 – Configure and deploy Traefik
# ============================================================
- name: Deploy Traefik Reverse Proxy
  hosts: traefik
  become: yes
  tags: [deploy]
  vars_files:
    - "../../inventory/group_vars/all.yml"

  tasks:
    - name: Include networking tasks
      include_tasks: tasks/configure_networking.yml

    - name: Include Traefik installation tasks
      include_tasks: tasks/install_traefik.yml

    - name: Include TLS certificate generation
      include_tasks: tasks/generate_tls_certificates.yml
      when: traefik_https_enabled | default(true) | bool

    - name: Include Traefik configuration tasks
      include_tasks: tasks/configure_traefik.yml

    - name: Include service verification tasks
      include_tasks: tasks/verify_service.yml

  handlers:
    - name: Restart traefik service
      systemd:
        name: traefik
        state: restarted
        daemon_reload: yes

# ============================================================
# PLAY 3 – Backup CA certificate to NAS for persistence
# ============================================================
- name: Backup Homelab CA Certificate to NAS
  hosts: localhost
  become: yes
  tags: [deploy]
  vars_files:
    - "../../inventory/group_vars/all.yml"

  tasks:
    - name: Check if CA certificate was fetched
      stat:
        path: /tmp/homelab-ca.crt
      register: tmp_ca

    - name: Backup CA to NAS and show trust instructions
      when: tmp_ca.stat.exists
      block:
        - name: Create Traefik directory on NAS
          file:
            path: "{{ nas_backup_mount }}/traefik"
            state: directory
            mode: '0755'

        - name: Backup CA certificate to NAS
          copy:
            src: /tmp/homelab-ca.crt
            dest: "{{ nas_backup_mount }}/traefik/ca.crt"
            mode: '0644'

        - name: Backup CA private key to NAS
          copy:
            src: /tmp/homelab-ca.key
            dest: "{{ nas_backup_mount }}/traefik/ca.key"
            mode: '0600'

        - name: Clean up temporary files
          file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/homelab-ca.crt
            - /tmp/homelab-ca.key

        - name: Display CA trust instructions
          debug:
            msg: |
              ════════════════════════════════════════════════════
              Homelab Root CA backed up to {{ nas_backup_mount }}/traefik/ca.crt

              To trust on macOS:
                scp root@<proxmox-ip>:{{ nas_backup_mount }}/traefik/ca.crt ~/Downloads/homelab-ca.crt
                sudo security add-trusted-cert -d -r trustRoot \
                  -k /Library/Keychains/System.keychain ~/Downloads/homelab-ca.crt

              To trust on iOS:
                1. Transfer ca.crt to device (AirDrop/email)
                2. Settings → General → VPN & Device Mgmt → Install
                3. Settings → General → About → Certificate Trust → Enable

              To trust on Linux:
                sudo cp ca.crt /usr/local/share/ca-certificates/homelab-ca.crt
                sudo update-ca-certificates
              ════════════════════════════════════════════════════
