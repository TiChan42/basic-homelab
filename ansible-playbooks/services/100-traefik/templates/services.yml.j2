# ============================================
# Traefik Dynamic Configuration – managed by Ansible
# Service routing for all homelab web applications
#
# Routes are auto-generated from the Ansible inventory.
# Any host with  service_traefik.enabled: true  gets a route.
# Required host_vars:  service_name, service_backend_port, ansible_host
#   service_traefik: { enabled: true, domain: "..." }
# Optional host_vars:
#   traefik_scheme (default: http)
#   service_traefik.api_domain   – extra Host for API access
#   service_traefik.ws_domain    – extra Host for WebSocket access
# ============================================

http:
{% if traefik_dashboard_user is defined and not (traefik_dashboard_insecure | default(true) | bool) %}
  # --- Dashboard authentication middleware ---
  middlewares:
    dashboard-auth:
      basicAuth:
        users:
          - "{{ traefik_dashboard_user }}:{{ traefik_dashboard_password | password_hash('apr_md5_crypt') }}"
{% endif %}

  routers:
{% if traefik_dashboard_user is defined and not (traefik_dashboard_insecure | default(true) | bool) %}
    # ------------------------------------------------------------------
    # Traefik Dashboard – authenticated access
    # ------------------------------------------------------------------
    traefik-dashboard:
      rule: "Host(`{{ hostvars['traefik']['service_traefik']['domain'] | default('traefik.' + traefik_base_domain) }}`)"
      entryPoints:
        - websecure
      service: api@internal
      middlewares:
        - dashboard-auth
{% if traefik_acme_enabled | default(false) | bool %}
      tls:
        certResolver: letsencrypt
{% else %}
      tls: {}
{% endif %}

{% endif %}
{% for host in groups['all'] | default([]) %}
{% set svc_traefik = hostvars[host].get('service_traefik', {}) %}
{% if svc_traefik.get('enabled', false) | bool and svc_traefik.get('domain', '') | length > 0 %}
{% set api_domain = svc_traefik.get('api_domain', '') %}
{% set ws_domain = svc_traefik.get('ws_domain', '') %}
{% set all_domains = [svc_traefik['domain']] %}
{% if api_domain | length > 0 %}{% set _ = all_domains.append(api_domain) %}{% endif %}
{% if ws_domain | length > 0 %}{% set _ = all_domains.append(ws_domain) %}{% endif %}
{% set host_rule = all_domains | map('regex_replace', '^(.*)$', 'Host(`\1`)') | join(' || ') %}
    # ------------------------------------------------------------------
    # {{ host }} – {{ hostvars[host]['ansible_host'] | default('unknown') }}
    #   frontend: {{ svc_traefik['domain'] }}
{% if api_domain | length > 0 %}
    #   api:      {{ api_domain }}
{% endif %}
{% if ws_domain | length > 0 %}
    #   ws:       {{ ws_domain }}
{% endif %}
    # ------------------------------------------------------------------
    {{ host }}:
      rule: "{{ host_rule }}"
      entryPoints:
        - websecure
      service: {{ host }}
{% if traefik_acme_enabled | default(false) | bool %}
      tls:
        certResolver: letsencrypt
{% else %}
      tls: {}
{% endif %}

    {{ host }}-http:
      rule: "{{ host_rule }}"
      entryPoints:
        - web
      service: {{ host }}

{% endif %}
{% endfor %}

  services:
{% for host in groups['all'] | default([]) %}
{% set svc_traefik = hostvars[host].get('service_traefik', {}) %}
{% if svc_traefik.get('enabled', false) | bool and svc_traefik.get('domain', '') | length > 0 %}
    {{ host }}:
      loadBalancer:
        servers:
          - url: "{{ hostvars[host]['traefik_scheme'] | default('http') }}://{{ hostvars[host]['ansible_host'] }}:{{ hostvars[host]['service_backend_port'] }}"
{% endif %}
{% endfor %}

{% if not (traefik_https_enabled | default(true) | bool) %}
# TLS disabled – using self-signed or no TLS
{% else %}
# --- TLS Configuration ---
tls:
  options:
    default:
      minVersion: VersionTLS12
{% endif %}
