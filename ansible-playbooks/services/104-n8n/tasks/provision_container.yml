---
# tasks/provision_container.yml – LXC Container auf Proxmox erstellen & starten
#
# Benötigte Variablen (aus group_vars/all.yml):
#   proxmox_api_host, proxmox_api_user, proxmox_api_token_id/secret
#   proxmox_node, default_lxc_template, default_storage
#   n8n_container_cores, n8n_container_memory, n8n_container_rootfs
#   network_cidr, network_gateway
# Per host (from inventory/hosts.yml):
#   service_id, service_frontend_port, service_backend_port

# ------------------------------------------------------------------
# Prerequisites
# ------------------------------------------------------------------
- name: Ensure Proxmox API library is installed
  apt:
    name: python3-proxmoxer
    state: present
    update_cache: yes

- name: Get list of available OS templates
  command: "pveam list local"
  register: pveam_list
  changed_when: false

- name: Download OS template if missing
  command: "pveam download local {{ default_lxc_template.split('/')[-1] }}"
  when: default_lxc_template.split('/')[-1] not in pveam_list.stdout

# ------------------------------------------------------------------
# Container creation
# ------------------------------------------------------------------
- name: Create n8n LXC container
  community.proxmox.proxmox:
    api_host: "{{ proxmox_api_host }}"
    api_user: "{{ proxmox_api_user }}"
    api_token_id: "{{ proxmox_api_token_id }}"
    api_token_secret: "{{ proxmox_api_token_secret }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ hostvars[item]['service_id'] }}"
    hostname: "{{ item }}"
    ostemplate: "{{ default_lxc_template }}"
    cores: "{{ n8n_container_cores }}"
    memory: "{{ n8n_container_memory }}"
    swap: 512
    disk: "{{ n8n_container_rootfs }}"
    netif:
      net0: "name=eth0,bridge=vmbr0,ip={{ hostvars[item]['ansible_host'] }}{{ network_cidr }},gw={{ network_gateway }}"
    pubkey: "{{ lookup('file', '/root/.ssh/id_rsa.pub') }}"
    onboot: yes
    state: present
  loop: "{{ groups['n8n'] }}"
  loop_control:
    label: "{{ item }} (VMID {{ hostvars[item]['service_id'] }})"

# ------------------------------------------------------------------
# NAS bind mount (host /mnt/nas → container /mnt/nas)
# ------------------------------------------------------------------
- name: Ensure NAS bind mount is configured on n8n container
  shell: |
    VMID={{ hostvars[item]['service_id'] }}
    if pct config $VMID | grep -q "^mp0:"; then
      echo "OK"
    else
      pct set $VMID -mp0 {{ nas_mount }},mp={{ nas_mount }}
      # If container is already running, stop it so mount takes effect on next start
      if pct status $VMID 2>/dev/null | grep -q "running"; then
        pct stop $VMID --timeout 30
        sleep 2
      fi
      echo "CONFIGURED"
    fi
  register: nas_mount_config
  changed_when: "'CONFIGURED' in nas_mount_config.stdout"
  loop: "{{ groups['n8n'] }}"
  loop_control:
    label: "{{ item }}"

- name: Ensure NAS backup directory for n8n exists
  file:
    path: "{{ nas_backup_mount }}/n8n"
    state: directory
    mode: '0777'

- name: Ensure n8n container is running
  community.proxmox.proxmox:
    api_host: "{{ proxmox_api_host }}"
    api_user: "{{ proxmox_api_user }}"
    api_token_id: "{{ proxmox_api_token_id }}"
    api_token_secret: "{{ proxmox_api_token_secret }}"
    node: "{{ proxmox_node }}"
    hostname: "{{ item }}"
    vmid: "{{ hostvars[item]['service_id'] }}"
    state: started
  loop: "{{ groups['n8n'] }}"
  loop_control:
    label: "{{ item }}"

- name: Wait for SSH to become available
  wait_for:
    host: "{{ hostvars[item]['ansible_host'] }}"
    port: 22
    timeout: 60
    search_regex: OpenSSH
    delay: 5
  loop: "{{ groups['n8n'] }}"
  loop_control:
    label: "{{ item }}"

# ------------------------------------------------------------------
# Host networking (DNS + Port-Forwarding)
# ------------------------------------------------------------------
- name: Add n8n container DNS entry to /etc/hosts
  lineinfile:
    path: /etc/hosts
    line: "{{ hostvars[item]['ansible_host'] }} {{ item }}"
    state: present
    mode: '0644'
  loop: "{{ groups['n8n'] }}"
  loop_control:
    label: "{{ item }}"

- name: Forward n8n port ({{ hostvars[item]['service_frontend_port'] }}) to container
  ansible.builtin.iptables:
    table: nat
    chain: PREROUTING
    protocol: tcp
    destination_port: "{{ hostvars[item]['service_frontend_port'] }}"
    jump: DNAT
    to_destination: "{{ hostvars[item]['ansible_host'] }}:{{ hostvars[item]['service_backend_port'] }}"
    comment: "Forward n8n {{ hostvars[item]['service_frontend_port'] }} -> {{ item }}"
  loop: "{{ groups['n8n'] }}"
  loop_control:
    label: "{{ item }} (:{{ hostvars[item]['service_frontend_port'] }})"
