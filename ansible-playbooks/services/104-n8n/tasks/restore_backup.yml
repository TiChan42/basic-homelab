---
# tasks/restore_backup.yml – NAS-Backup prüfen & wiederherstellen
#
# Läuft im Container (hosts: n8n).
# Idempotent: Wird übersprungen, wenn lokale Daten mit echtem Inhalt vorhanden sind.
# Eine leere Datenbank (0 Workflows, z.B. nach Auto-Start) wird entfernt,
# damit ein vorhandenes NAS-Backup wiederhergestellt werden kann.

- name: Ensure n8n backup directory on NAS exists
  file:
    path: "{{ nas_backup_mount }}/n8n"
    state: directory
    mode: '0777'

- name: Stop n8n before restore check (in case of re-run)
  systemd:
    name: n8n
    state: stopped
  failed_when: false

- name: Check if local n8n database exists
  stat:
    path: "{{ n8n_data_dir }}/database.sqlite"
  register: n8n_db_file

- name: Check if existing database has real data (workflows)
  shell: |
    python3 -c "
    import sqlite3
    try:
        conn = sqlite3.connect('{{ n8n_data_dir }}/database.sqlite')
        c = conn.cursor()
        c.execute('PRAGMA wal_checkpoint(FULL)')
        c.execute('SELECT COUNT(*) FROM workflow_entity')
        print(c.fetchone()[0])
        conn.close()
    except:
        print(0)"
  register: n8n_workflow_count
  when: n8n_db_file.stat.exists
  failed_when: false
  changed_when: false

- name: Remove empty database to allow restore from NAS backup
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ n8n_data_dir }}/database.sqlite"
    - "{{ n8n_data_dir }}/database.sqlite-wal"
    - "{{ n8n_data_dir }}/database.sqlite-shm"
  when:
    - n8n_db_file.stat.exists
    - (n8n_workflow_count.stdout | default('0') | trim) == '0'

- name: Re-check if local n8n database exists after cleanup
  stat:
    path: "{{ n8n_data_dir }}/database.sqlite"
  register: n8n_db_file

- name: Find available NAS backup archives (numbered, 0 = newest)
  stat:
    path: "{{ nas_backup_mount }}/n8n/n8n_backup.{{ item }}.tar.gz"
  register: nas_backup_candidates
  loop: "{{ range(0, n8n_backup_keep_count) | list }}"
  when: not n8n_db_file.stat.exists

- name: Set best available backup to restore from
  set_fact:
    n8n_restore_archive: >-
      {{ (nas_backup_candidates.results | default([])
          | selectattr('stat.exists', 'defined')
          | selectattr('stat.exists')
          | first).stat.path | default('') }}
  when: not n8n_db_file.stat.exists

- name: Restore n8n data from NAS backup archive
  unarchive:
    src: "{{ n8n_restore_archive }}"
    dest: /
    remote_src: yes
  when:
    - not n8n_db_file.stat.exists
    - n8n_restore_archive | default('') | length > 0
