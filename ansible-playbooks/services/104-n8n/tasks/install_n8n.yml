---
# tasks/install_n8n.yml – Node.js + n8n installieren
#
# Läuft im Container (hosts: n8n).
# Installiert immer die neueste stabile Version via npm.

# ------------------------------------------------------------------
# System-Abhängigkeiten
# ------------------------------------------------------------------
- name: Install system dependencies
  apt:
    name:
      - git
      - curl
      - gnupg
      - nfs-common
      - build-essential
      - python3
    state: present
    update_cache: yes

# ------------------------------------------------------------------
# Node.js (via NodeSource)
# ------------------------------------------------------------------
- name: Add NodeSource GPG keyring
  shell: |
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key \
      | gpg --dearmor -o /usr/share/keyrings/nodesource.gpg
  args:
    creates: /usr/share/keyrings/nodesource.gpg

- name: Add Node.js repository
  copy:
    dest: /etc/apt/sources.list.d/nodesource.list
    content: "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ n8n_node_version }}.x nodistro main\n"
    mode: '0644'
  register: nodesource_repo

- name: Install Node.js
  apt:
    name: nodejs
    state: latest
    update_cache: yes

# ------------------------------------------------------------------
# n8n (global, neueste stabile Version)
# ------------------------------------------------------------------
- name: Install/update n8n globally via npm
  npm:
    name: n8n
    global: yes
    state: latest

- name: Ensure n8n data directory exists
  file:
    path: "{{ n8n_data_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0750'
