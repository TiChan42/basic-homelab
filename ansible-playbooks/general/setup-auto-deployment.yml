---
- name: Setup Auto-Deployment via Polling for Homelab
  hosts: localhost
  connection: local
  become: yes
  vars_files:
    - "{{ playbook_dir }}/../vars.yml"

  tasks:
    - name: Install required packages
      apt:
        name:
          - git
        state: present
        update_cache: yes

    - name: Create directory for repo
      file:
        path: "{{ repo_path }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Clone or update repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_path }}"
        version: main
        update: yes

    - name: Create polling deployment script
      copy:
        dest: "{{ polling_script_path }}"
        content: |
          #!/bin/bash
          REPO_PATH="{{ repo_path }}"
          SCRIPT_DIR="$REPO_PATH/scripts"

          cd "$REPO_PATH" || exit 1

          # Fetch latest changes
          git fetch origin

          # Check if local main is behind origin/main
          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse origin/main)

          if [ "$LOCAL" != "$REMOTE" ]; then
              echo "New changes detected. Deploying..."

              # Pull latest changes
              git pull origin main

              # Run install script
              if [ -f "$SCRIPT_DIR/install-necessary-apt-packages.sh" ]; then
                  bash "$SCRIPT_DIR/install-necessary-apt-packages.sh"
              fi

              # Run playbooks script
              if [ -f "$SCRIPT_DIR/run-all-playbooks.sh" ]; then
                  bash "$SCRIPT_DIR/run-all-playbooks.sh"
              fi

              echo "Deployment completed."
          else
              echo "No new changes."
          fi
        mode: '0755'

    - name: Create cron job for regular polling
      cron:
        name: "{{ polling_cron_name }}"
        minute: "{{ polling_minute }}"
        hour: "{{ polling_hour }}"
        job: "{{ polling_script_path }}"
        user: root

    - name: Create @reboot cronjob for post-restart deployment
      cron:
        name: "homelab-post-restart-deployment"
        special_time: reboot
        job: "git -C {{ repo_path }} pull && bash {{ repo_path }}/scripts/install-necessary-apt-packages.sh && bash {{ repo_path }}/scripts/run-all-playbooks.sh"
        user: root