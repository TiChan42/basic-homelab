---
- name: Setup Auto-Deployment via Polling for Homelab
  hosts: localhost
  connection: local
  become: yes
  # Workaround for implicit localhost not loading group_vars automatically
  vars_files:
    - "../inventory/group_vars/all.yml"

  tasks:
    - name: Install required packages
      apt:
        name:
          - git
        state: present
        update_cache: yes

    - name: Create directory for repo
      file:
        path: "{{ repo_path }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Clone or update repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_path }}"
        version: main
        update: yes

    - name: Create polling deployment script
      template:
        src: templates/homelab_auto_deployment.sh.j2
        dest: "{{ polling_script_path }}"
        mode: '0755'

    - name: Create cron job for regular polling
      cron:
        name: "{{ polling_cron_name }}"
        minute: "{{ polling_minute }}"
        hour: "{{ polling_hour }}"
        job: "{{ polling_script_path }}"
        user: root

    - name: Create @reboot cronjob for post-restart deployment
      cron:
        name: "homelab-post-restart-deployment"
        special_time: reboot
        job: "git -C {{ repo_path }} pull && bash {{ repo_path }}/scripts/install-necessary-apt-packages.sh && bash {{ repo_path }}/scripts/run-all-playbooks.sh"
        user: root