# mount-persistent-storage.yml
- name: Mount NAS NFS share on Proxmox host
  hosts: localhost
  connection: local
  become: true

  tasks:
    - name: Install required packages (NFS client)
      ansible.builtin.apt:
        name:
          - nfs-common
        state: present
        update_cache: true

    - name: Ensure NAS base mount directory exists
      ansible.builtin.file:
        path: "{{ nas_mount }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Persistently mount NFS share (writes /etc/fstab and mounts)
      ansible.posix.mount:
        path: "{{ nas_mount }}"
        src: "{{ nas_ip }}:{{ nas_nfs_export }}"
        fstype: nfs
        opts: "{{ nas_nfs_opts }}"
        state: mounted

    - name: Ensure standard subdirectories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - "{{ nas_services_mount }}"
        - "{{ nas_backup_mount }}"

    - name: Verify mount is active
      ansible.builtin.command: "findmnt -no TARGET,SOURCE,FSTYPE,OPTIONS {{ nas_mount }}"
      register: findmnt_out
      changed_when: false

    - name: Show mount details
      ansible.builtin.debug:
        msg: "{{ findmnt_out.stdout }}"
