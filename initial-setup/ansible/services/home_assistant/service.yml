# File: initial-setup/ansible/home_assistant.yml
- hosts: localhost
  gather_facts: no
  tasks:
    - name: "HAOS | Check for existing VM by name"
      shell: qm list | grep " {{ service_config.name }} " | awk '{print $1}'
      register: existing_vmid
      changed_when: false

    - name: "HAOS | Get next free VM ID"
      shell: pvesh get /cluster/nextid --output-format json | jq -r '.'
      register: next_vmid
      when: existing_vmid.stdout == ""
      changed_when: false

    - name: "HAOS | Set VMID variable"
      set_fact:
        ha_target_id: "{{ existing_vmid.stdout if existing_vmid.stdout != '' else next_vmid.stdout }}"

    - name: Download and run Home Assistant OS VM install script
      shell: >
        bash -c "$(curl -fsSL https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main/vm/haos-vm.sh)"
      args:
        warn: false
      environment:
        PVE_NODE: "{{ inventory_hostname }}"   # Node name for script (localhost)
        VMID: "{{ ha_target_id }}"
        VMNAME: "{{ service_config.name }}"
        CPU: "{{ service_config.allocations.cpu | default('2') }}"
        RAM: "{{ service_config.allocations.ram | default('4096') }}"
        DISK: "{{ service_config.allocations.disk | default('32G') }}"
        BRIDGE: "vmbr0"
      register: ha_install
      ignore_errors: yes

    - name: Ensure Home Assistant VM is started
      shell: qm start {{ ha_target_id }}
      when: ha_install is succeeded
