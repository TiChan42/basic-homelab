# File: initial-setup/ansible/zigbee2mqtt_container.yml
- hosts: localhost
  gather_facts: no
  tasks:
    - name: "Z2M | Check for existing CT by name"
      shell: pct list | grep " {{ service_config.name }} " | awk '{print $1}'
      register: existing_ctid
      changed_when: false

    - name: "Z2M | Get next free CT ID"
      shell: pvesh get /cluster/nextid --output-format json | jq -r '.'
      register: next_ctid
      when: existing_ctid.stdout == ""
      changed_when: false

    - name: "Z2M | Set CTID variable"
      set_fact:
        z2m_target_id: "{{ existing_ctid.stdout if existing_ctid.stdout != '' else next_ctid.stdout }}"

    - name: Create Zigbee2MQTT LXC container using community script (privileged for USB access)
      shell: >
        bash -c "$(wget -qLO - https://github.com/community-scripts/ProxmoxVE/raw/main/ct/zigbee2mqtt.sh)"
      args:
        warn: false
      environment:
        PVE_NODE: "{{ inventory_hostname }}"
        CTID: "{{ z2m_target_id }}"
        HOSTNAME: "{{ service_config.hostname }}"
        PRIVILEGED: "yes"
      register: z2m_result
      ignore_errors: yes

    - name: "Z2M | Find MQTT service config"
      set_fact:
        mqtt_service_item: "{{ services | selectattr('name', 'equalto', 'MQTT') | first | default({}) }}"

    - name: "Z2M | Set MQTT vars for template"
      set_fact:
        mqtt_user: "{{ mqtt_service_item.variables.user | default('mqtt-user') }}"
        mqtt_password: "{{ mqtt_service_item.variables.password }}"
        mqtt_ct_name: "{{ mqtt_service_item.hostname | default('mqtt') }}"

    - name: "Z2M | Create data directory on host"
      file:
        path: "/var/lib/homelab-data/zigbee2mqtt"
        state: directory
        owner: homelab
        group: homelab
        mode: '0755'

    - name: Generate Zigbee2MQTT configuration file (on Host)
      when: z2m_result is succeeded
      template:
        src: "../services/zigbee2mqtt/templates/zigbee2mqtt_config.yaml.j2"
        dest: "/var/lib/homelab-data/zigbee2mqtt/configuration.yaml"
        owner: homelab
        group: homelab
        mode: '0644'

    - name: "Z2M | Bind Mount data directory"
      shell: |
        pct set {{ z2m_target_id }} -mp0 /var/lib/homelab-data/zigbee2mqtt,mp=/opt/zigbee2mqtt/data
      when: z2m_result is succeeded

    - name: Start Zigbee2MQTT service
      shell: pct start {{ z2m_target_id }}
      when: z2m_result is succeeded
