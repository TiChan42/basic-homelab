# File: initial-setup/ansible/mqtt_container.yml
- hosts: localhost
  gather_facts: no
  tasks:
    - name: "MQTT | Check for existing CT by name"
      shell: pct list | grep " {{ service_config.name }} " | awk '{print $1}'
      register: existing_ctid
      changed_when: false

    - name: "MQTT | Get next free CT ID"
      shell: pvesh get /cluster/nextid --output-format json | jq -r '.'
      register: next_ctid
      when: existing_ctid.stdout == ""
      changed_when: false

    - name: "MQTT | Set CTID variable"
      set_fact:
        mqtt_target_id: "{{ existing_ctid.stdout if existing_ctid.stdout != '' else next_ctid.stdout }}"

    - name: Create MQTT LXC container using community script
      shell: >
        bash -c "$(wget -qLO - https://github.com/community-scripts/ProxmoxVE/raw/main/ct/mqtt.sh)"
      args:
        warn: false
      environment:
        PVE_NODE: "{{ inventory_hostname }}"
        CTID: "{{ mqtt_target_id }}"
        HOSTNAME: "{{ service_config.hostname }}"
      register: mqtt_result
      ignore_errors: yes

    - name: "MQTT | Create data directory on host"
      file:
        path: "/var/lib/homelab-data/mqtt"
        state: directory
        owner: homelab
        group: homelab
        mode: '0755'

    - name: "MQTT | Generate Mosquitto password file"
      shell: |
        # Create a temporary password file and hash it
        touch /var/lib/homelab-data/mqtt/passwd
        mosquitto_passwd -b /var/lib/homelab-data/mqtt/passwd {{ service_config.variables.user }} {{ service_config.variables.password }}
      when: mqtt_result is succeeded
      # Note: Requires mosquitto-clients on host or we run inside container and copy out.
      # Simpler: Generate inside container to be safe about hashing, then pull out?
      # Or just use the plaintext for now and let mosquitto hash it? (Mosquitto needs hashed).
      # Correction: We can't assume mosquitto_passwd is on the host. 
      # We will stick to exec inside container to generate passwd, BUT move it to host storage.

    - name: "MQTT | Setup Config and Passwd via Container"
      shell: |
        # Generate passwd inside
        pct exec {{ mqtt_target_id }} -- mosquitto_passwd -c /etc/mosquitto/passwd {{ service_config.variables.user }} {{ service_config.variables.password }}
        # Copy passwd out to host storage
        pct pull {{ mqtt_target_id }} /etc/mosquitto/passwd /var/lib/homelab-data/mqtt/passwd
        # Write Config directly to Host Storage
        echo -e 'allow_anonymous false\npersistence true\npassword_file /etc/mosquitto/passwd\nlistener 1883' > /var/lib/homelab-data/mqtt/mosquitto.conf
        # Set ownership
        chown homelab:homelab /var/lib/homelab-data/mqtt/passwd
        chown homelab:homelab /var/lib/homelab-data/mqtt/mosquitto.conf
      when: mqtt_result is succeeded

    - name: "MQTT | Bind Mount config directory"
      shell: |
        # Mount host dir to /etc/mosquitto. 
        # Note: This hides the original /etc/mosquitto, so we must ensure mosquitto.conf is there.
        pct set {{ mqtt_target_id }} -mp0 /var/lib/homelab-data/mqtt,mp=/etc/mosquitto
      when: mqtt_result is succeeded

    - name: Restart Mosquitto service
      shell: pct reboot {{ mqtt_target_id }}
      when: mqtt_result is succeeded
